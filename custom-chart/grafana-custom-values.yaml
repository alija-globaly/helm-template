replicas: 1

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPU: "60"
  targetMemory: ""
  behavior: {}


# Headless service for HA
headlessService: false

# Docker image for Grafana
image:
  repository: grafana/grafana
  tag: 12.1.0-ubuntu
  pullPolicy: IfNotPresent

# Service definition
service:
  # type: ClusterIP
  type: NodePort
  port: 80
  targetPort: 3000
  nodePort: 30002
  annotations: {}
    # For AWS NLB:
    # service.beta.kubernetes.io/aws-load-balancer-type: nlb
    # service.beta.kubernetes.io/aws-load-balancer-internal: "true"


# Ingress with TLS
ingress:
  enabled: false
  ingressClassName: nginx
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
  hosts:
    - grafana.example.com
  path: /
  pathType: Prefix
  tls:
    - secretName: grafana-tls-prod
      hosts:
        - grafana.example.com


# Persistence
persistence:
  enabled: true
  type: pvc
  storageClassName: "microk8s-hostpath" 
  accessModes:
    - ReadWriteOnce
  size: 10Gi 
  # finalizers:
  #   - kubernetes.io/pvc-protection


adminUser: xx
adminPassword: xx

# Use an existing secret for the admin user.
# admin:
  # Name of the secret. Can be templated.
  # existingSecret: ""
  # userKey: admin
  # passwordKey: admin

# Resources for Grafana pod
resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

nodeSelector: {}
  # nodeType: monitoring

# Anti-affinity to spread pods across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
          topologyKey: kubernetes.io/hostname

tolerations: []

podSecurityContext:
  fsGroup: 472
  fsGroupChangePolicy: OnRootMismatch
  
containerSecurityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop: [ALL]     
  seccompProfile:
    type: RuntimeDefault
  readOnlyRootFilesystem: false

# Grafana configuration
grafana.ini:
  paths:
    data: /var/lib/grafana/
    logs: /var/log/grafana
    plugins: /var/lib/grafana/plugins
    provisioning: /etc/grafana/provisioning
  
  analytics:
    check_for_updates: false
    reporting_enabled: false
  
  log:
    mode: console
    level: warn  # Reduced logging for production
  
  server:
    domain: grafana.example.com
    root_url: "https://%(domain)s/"

  # unified_alerting:
  #   enabled: true
  

  smtp:
    enabled: false
    host: smtp.gmail.com:587
    user: alerts@example.com
    password: $__env{SMTP_PASSWORD}
    from_address: alerts@example.com
    from_name: Grafana Staging
    skip_verify: false


# envValueFrom:
#   GF_SECURITY_SECRET_KEY:
#     secretKeyRef:
#       name: grafana-secrets
#       key: secret-key
#   DB_PASSWORD:
#     secretKeyRef:
#       name: grafana-db-secret
#       key: password
#   SMTP_PASSWORD:
#     secretKeyRef:
#       name: grafana-smtp-secret
#       key: password


# Datasources
# datasources:
#   datasources.yaml:
#     apiVersion: 1
#     datasources:
#       - name: Prometheus
#         type: prometheus
#         url: http://prometheus-server.monitoring.svc.cluster.local
#         access: proxy
#         isDefault: true
#         editable: false
#         jsonData:
#           timeInterval: 30s
#           queryTimeout: 60s
#           httpMethod: POST
      
#       - name: Loki
#         type: loki
#         url: http://loki.monitoring.svc.cluster.local:3100
#         access: proxy
#         editable: false
#         jsonData:
#           maxLines: 1000
      
#       - name: Tempo
#         type: tempo
#         url: http://tempo.monitoring.svc.cluster.local:3100
#         access: proxy
#         editable: false

# Dashboard providers
dashboardProviders:
  dashboardproviders.yaml:
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: false  # Read-only in production
        options:
          path: /var/lib/grafana/dashboards/default
      
      - name: 'kubernetes'
        orgId: 1
        folder: 'Kubernetes'
        type: file
        disableDeletion: false
        editable: false
        options:
          path: /var/lib/grafana/dashboards/kubernetes

# Health checks
livenessProbe:
  httpGet:
    path: /api/health
    port: 3000
  initialDelaySeconds: 60
  timeoutSeconds: 30
  periodSeconds: 10
  failureThreshold: 10

readinessProbe:
  httpGet:
    path: /api/health
    port: 3000
  initialDelaySeconds: 30
  timeoutSeconds: 30
  periodSeconds: 10
  failureThreshold: 3

# Pod Disruption Budget (HA)
podDisruptionBudget:
  enabled: false
  # enabled: true
  # minAvailable: 1
